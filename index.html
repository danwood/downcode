<?php
$iOS = false;       // or set to a non-false text value
if (preg_match("/(\\(iPod|\\(iPhone|\\(iPad)/", $_SERVER['HTTP_USER_AGENT'], $matches)) {
    $iOS = substr($matches[1], 1);
}
$code = isset($_GET['code']) ? htmlspecialchars($_GET['code']) : '';
$email = isset($_GET['email']) ? htmlspecialchars($_GET['email']) : '';
?>




<style>
.redeem {
    background-color:#bdbdbd;
    color:white;
    padding:1em;
    margin-top:-30px;
}

@media only screen and (min-width: 500px) {

    .redeem {
        float:right;
        width:16em;
        margin:0 1em 0.5em 1.5em;
    }
}

.redeem input {
    width:100%;
    color:black;
    font-size:120%;
    background: #f5f5f5;
}

.redeem input[type=submit] {
    border-radius: 28px;
    text-shadow: 0px 1px 3px #666666;
    color: #ffffff;
    background: #3498db;
    padding: 5px 20px;
    border:none;
    margin-top:10px;
}

.redeem input[type=submit]:hover {
  background: #3cb0fd;
}
.redeem input[type=submit]:disabled {
  background: #888888;
}

body { position: relative;}
#cover {
    position:absolute;
    top:0;left:0;
    background:rgba(0,0,0,0.5);
    z-index:1000;
    width:100%;
    height:100%;
}
#redeemer {
    position: fixed;
    top: 20%;
    left:50%;
    transform: translate(-50%, -20%);

    min-width:600px;
    max-width:100%;
    min-height:300px;
    max-height:100%;
    margin:auto auto;
    background:white;
    color:red;
    border:5px solid black;
    border-radius:10px;
    padding:10px;
    z-index:1010;
    box-shadow: 0 0 0 5px rgba(0,0,0,0.999);
}
#close-redeem {
    position:fixed;
    top:40px;
    right:40px;
    font-size:600%;
    color:white;
    z-index:1011;
}

</style>



 <!-- just before section.bio -->
                 <aside class="redeem">
                        <form id="redeem-form">
                            <input type="text" id="redeem-input" name="code" pattern="[A-Za-z0-9- ]+{6,12}$"
                                value="<?php echo htmlspecialchars($code); ?>" />
                            <input type="hidden" name="email" value="<?php echo htmlspecialchars($email); ?>" />
                            <input type="submit" name="go" id="redeem-submit" value="Submit Download Code" disabled />
                        </form>
                    </aside>




<!-- jquery already loaded -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>



<!-- just before scripts -->

        <div id="cover" style="display:none">
        </div>
        <div id="redeemer" style="display:none">
        </div>
        <div id="close-redeem" style="display:none">&#215;</div>



<script>
$('#redeem-form').submit(function( event ) {
    $('#redeem-submit').prop( "disabled", true );
    $.ajax({
      type: 'POST',
      url: '/redeem.php',
      data: $("#redeem-form").serialize(),

      success: function(data, textStatus, jqXHR ) {
            if (data != '') {
                $('#cover').show();
                $('#redeemer').show();
                $('#close-redeem').show();
                $('#redeemer').html(data);  // We're done; let the content here do the rest.
            } else {
                alert('Sorry, but the code you entered has already been redeemed or was entered incorrectly.');
                $('#redeem-input').focus();
            }
      },
      error: function(jqXHR, textStatus, errorThrown ) {
            alert(errorThrown + ' ' + textStatus);
      },
      complete: function(jqXHR, textStatus ) {
            $('#redeem-submit').prop( "disabled", false );
      }
    });
    event.preventDefault();
});
$('#close-redeem').click(function() {
    $('#cover').fadeOut('slow');
    $('#close-redeem').fadeOut('slow');
    $('#redeemer').fadeOut('fast');
});

$('#redeem-input').on('change keyup paste', function () {
    var disabled = $(this).val() == '';
   $('#redeem-submit').prop( "disabled", disabled);
});


// Automatically submit when code provided in the URL
<?php
if ($code) {
?>
$('#redeem-form').submit();
<?php
}
?>
</script>


